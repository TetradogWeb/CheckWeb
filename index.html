<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <style>
        .serie {

            border: black solid 1px;
            margin: 5px;

        }

        .nombreSerie {
            font-weight: bold;
            text-align: center;
        }

        .temporada {
            position: relative;
            float: left;
            font-size: 300%;
            width: 30px;
        }

        .subEsp {
            position: relative;
            float: left;
            color: blueviolet;
            width: 70px;
            background-image: url("subEsp.png");
            background-repeat: no-repeat;
            background-position: 10px;
            background-size: 15px;


        }

        .castellano {
            position: relative;
            float: left;
            color: rebeccapurple;
            width: 70px;
            background-image: url("esp.png");
            background-repeat: no-repeat;
            background-position: 10px;
            background-size: 15px;

        }
    </style>
    <script>
        class Serie {
            constructor(url) {
                var urlLimiandose = url.replace(Serie.UrlHome, '');
                var indexFin = urlLimiandose.indexOf(Serie.ParamTemporada);
                this.Titulo = urlLimiandose.substring(0, indexFin);
                this.Temporadas = [];
                this.Init = this.Update();
            }
            get Id(){
                return '#'+this.Titulo;
            }
            get Nombre() {
                return this.Titulo.replace('-', ' ');
            }
             
            static get UrlHome() {
                return "https://pelisplus.icu/";
            }
            static get ParamTemporada() {
                return "-temporada-";
            }
            static get ParamCapitulo() {
                return "-capitulo-";
            }
            GetOuterHTML(){
                var outer="<div id='#"+this.Titulo+"' class='serie'>";
                    outer+=GetInnerHTML();

                outer+="</div";
                return outer;
            }
            GetInnerHTML(){
                var inner="<div>";
                    //Nombre
                    inner+="<h2>"+this.Nombre+"</h2>";
                    //idioma,temporada,ultimo capitulo

                inner+="</div";
                return inner;
            }
            Url(temp = 1, cap = 1) {
                return Serie.UrlHome + this.Titulo + Serie.ParamTemporada + temp + Serie.ParamCapitulo + cap;
            }
            Update() {
                return UpdateList().then(() => {
                    return Promise.all(this.Temporadas.map((t) => t.Update()));
                });
            }
            UpdateList() {
                var ultima = this.Temporadas.length + 1;
                var urlTemporada = this.Url(ultima);
                return Serie.PaginaHtml(urlTemporada).then(Serie.Existe).then((existe) => {
                    if (existe) {
                        return UpdateList();
                    }
                });
            }
            static PaginaHtml(url) {
                return fetch(url).then((r) => r.text());
            }
            static Existe(paginaHtml) {
                const NOT_FOUND = "404";
                return !paginaHtml.includes(NOT_FOUND) && paginaHtml.length < 20;
            }
        }
        class Temporada {
            constructor(url) {
                //numero
                var inicio = url.lastIndexOf(Serie.ParamTemporada) + Serie.ParamTemporada.length;
                this.Numero = url.substr(incio, url.indexOf(Serie.ParamCapitulo) - inicio);
                this.Capitulos = [];
                this.Url = url.substr(0, url.lastIndexOf('-') + 1);
                this.Init = Serie.PaginaHtml(this.PrimerCapitulo).then(Serie.Existe).then((existe) => {
                    this.Existe = existe;
                    if (existe) {
                        return this.Update();
                    }
                });
            }
            get PrimerCapitulo() {
                return this.Url + 1;
            }
            Update() {
                return UpdateList().then(() => UpdateLang());
            }
            UpdateLang() {
                var promesas = [];

                //miro si hay más idiomas
                for (var i = 0; i < this.Capitulos.length; i++) {
                    promesas.push(this.Capitulos[i].Update());
                }
                return Promise.all(promesas);
            }
            UpdateList() {
                //miro si hay más capitulos
                var ultimo = this.Capitulos.length + 1;//si no hay será el primero :)
                var urlUltimoCapitulo = this.Url + ultimo;
                return Serie.PaginaHtml(urlUltimoCapitulo).then(pagina => Serie.Existe(pagina)).then((existe) => {
                    if (existe) {
                        this.Capitulos.push(Capitulo(urlUltimoCapitulo));
                        return this.Capitulos[this.Capitulos.length - 1].Init.then(() => this.UpdateList());
                    }
                });
            }
        }
        class Capitulo {

            constructor(url) {
                //numero
                this.Numero = url.substr(url.lastIndexOf('-') + 1);
                this.Url = url;
                this.Init = this.Update();

            }
            Update() {
                return Serie.PaginaHtml(this.Url).then(pagina => {
                    var aux;
                    //existe
                    this.Existe = Serie.Existe(pagina);
                    //idiomas
                    if (this.Existe) {
                        aux = document.createElement('div');
                        aux.outerHTML = pagina;
                        aux = aux.getElementsByClassName('level1');

                        this.Idiomas = aux.children.map((c) => {
                            //li->a
                            var idioma;
                            switch (c.firstchild.innerText) {
                                case 'Latino': idioma = Idioma.Latino; break;
                                case 'Subtitulado': idioma = Idioma.SubEsp; break;
                                case 'Castellano': idioma = Idioma.Castellano; break;
                                default: idioma = Idioma(c.firstchild.innerText); break;
                            }
                            return idiomas;
                        });
                    }
                });
            }

        }
        class Idioma {
            constructor(nombre) {
                this.Nombre = nombre;
            }
            get UrlImg() {
                return this.Nombre + '.jpg';
            }
            static get Latino() {
                return Idioma('Latino');
            }
            static get Castellano() {
                return Idioma('Castellano');
            }
            static get SubEsp() {
                return Idioma('SubEsp');
            }
        }

        $(function () {
            var Series=[];
            //load
            if (window.localStorage.Series) {
                Series = JSON.parse(window.localStorage.getItem("Series"));
                Series.map(AddSerie);
            }

            function AddSerie(serie){
                if(!exists(serie.Id)){
                  $('#series').append(serie.GetOuterHTML());
                }
            }

            function Refresh(){
                var divSerie;
                for(var i=0;i<Series.length;i++){
                    divSerie=$(Series[i].Id);
                    divSerie.innerHTML=Serie[i].GetInnerHTML();
                }
            }

            function Update(){
                return Promise.all(Series.map((s)=>s.Update())).then(()=>Save()).then(()=>Refresh());
            }

            function Save(){
                window.localStorage.setItem("Series", JSON.stringify(Series));
            }



            function exists(elementName) {
                //source:https://stackoverflow.com/questions/4592493/check-if-element-exists-in-jquery
                 		return $(elementName).length; 
            }
        });

    </script>
</head>

<body>
    <div class="container">
        <div class="row">
            <input id="btnUpdateAll" type="button" class="btn btn-primary" value="Update All">
            <input id="inpUrlSerie" class="col-9 col-sm-6" type="text" placeholder="url serie" />
            <input id="btnAdd" type="button" class="btn btn-success"  value="Add" />
        </div>
        <div id="series" class="row"></div>
    </div>
    <script>
        load();
    </script>
</body>

</html>